<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:WorldBuilder.Modules.Landscape"
             xmlns:tools="clr-namespace:WorldBuilder.Shared.Modules.Landscape.Tools;assembly=WorldBuilder.Shared"
             xmlns:converters="clr-namespace:WorldBuilder.Converters"
             xmlns:views="clr-namespace:WorldBuilder.Views"
             x:Class="WorldBuilder.Modules.Landscape.Views.Components.ToolSettingsPanel"
             x:Name="SettingsRoot"
             x:DataType="vm:LandscapeViewModel">
    <UserControl.Resources>
      <converters:TextureToViewModelConverter x:Key="TextureConverter" />
      <DataTemplate x:Key="TextureGridTemplate" x:DataType="tools:ITexturePaintingTool">
        <StackPanel Spacing="4">
          <TextBlock Text="Texture" FontWeight="SemiBold" FontSize="12" Margin="0,4,0,0"/>
          <ComboBox ItemsSource="{Binding AllTextures}" 
                    SelectedItem="{Binding Texture}"
                    HorizontalAlignment="Stretch">
            <ComboBox.ItemTemplate>
              <DataTemplate>
                <StackPanel Orientation="Horizontal" Spacing="8" Background="Transparent"
                            ToolTip.Placement="Right">
                  <ToolTip.Tip>
                    <Border Width="512" Height="512">
                      <StackPanel Spacing="4" DataContext="{Binding Converter={StaticResource TextureConverter}}" x:DataType="converters:TextureLoader">
                        <TextBlock Text="{Binding Type}" FontWeight="SemiBold" FontSize="12" HorizontalAlignment="Center"/>
                        <Border Width="512" Height="512" Background="{DynamicResource ControlFillColorDefaultBrush}" CornerRadius="4" ClipToBounds="True">
                          <Image Stretch="UniformToFill" Source="{Binding Image}"/>
                        </Border>
                      </StackPanel>
                    </Border>
                  </ToolTip.Tip>
                  <Border Width="24" Height="24" 
                          Background="{DynamicResource ControlFillColorDefaultBrush}"
                          BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                          BorderThickness="1"
                          CornerRadius="4">
                    <Panel>
                    <Panel.DataContext>
                        <MultiBinding Converter="{StaticResource TextureConverter}" x:CompileBindings="False">
                          <Binding Path="$parent[Border].DataContext" />
                          <Binding RelativeSource="{RelativeSource AncestorType=ComboBox}" Path="DataContext" />
                          <Binding RelativeSource="{RelativeSource AncestorType=ComboBox}" Path="DataContext.ActiveDocument" />
                        </MultiBinding>
                    </Panel.DataContext>
                      <Image Width="20" Height="20" Stretch="UniformToFill" Source="{Binding Image, DataType=converters:TextureLoader}"/>
                    </Panel>
                  </Border>
                  <TextBlock Text="{Binding}" VerticalAlignment="Center" />
                </StackPanel>
              </DataTemplate>
            </ComboBox.ItemTemplate>
          </ComboBox>

          <StackPanel Spacing="4">
            <TextBlock Text="Scenery" FontWeight="SemiBold" FontSize="12" Margin="0,4,0,0"/>
            <ComboBox ItemsSource="{Binding AllSceneries}" 
                      SelectedItem="{Binding SelectedScenery}"
                      HorizontalAlignment="Stretch">
              <ComboBox.ItemTemplate>
                <DataTemplate x:DataType="tools:SceneryItem">
                  <StackPanel Orientation="Horizontal" Spacing="8" Background="Transparent"
                              ToolTip.Placement="Right">
                    <ToolTip.Tip>
                      <Border Width="512" Height="512">
                        <views:SceneryPreview Width="512" Height="512"
                                              IsTooltip="True"
                                              Texture="{Binding $parent[ComboBox].DataContext.Texture}"
                                              SceneryIndex="{Binding Index}"
                                              Dats="{Binding #SettingsRoot.((vm:LandscapeViewModel)DataContext).Dats}" />
                      </Border>
                    </ToolTip.Tip>
                    <TextBlock Text="{Binding DisplayIndex}" Opacity="0.5" Width="24" />
                    <TextBlock Text="{Binding Name}" VerticalAlignment="Center" />
                  </StackPanel>
                </DataTemplate>
              </ComboBox.ItemTemplate>
            </ComboBox>
          </StackPanel>
        </StackPanel>
      </DataTemplate>
    </UserControl.Resources>

    <Border Background="{DynamicResource SolidBackgroundFillColorBase}" 
            BorderBrush="{DynamicResource SurfaceStrokeColorDefault}"
            BorderThickness="1"
            CornerRadius="4" Padding="12"
            IsVisible="{Binding ActiveTool, Converter={x:Static ObjectConverters.IsNotNull}}">
      <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Spacing="10">
          <TextBlock Text="Tool Settings" FontWeight="SemiBold" FontSize="14" />

          <ContentControl Content="{Binding ActiveTool}">
            <ContentControl.DataTemplates>
              <DataTemplate DataType="{x:Type tools:BrushTool}">
                <StackPanel Spacing="8">
                  <Grid ColumnDefinitions="*,Auto">
                    <TextBlock Text="Size" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="1" Text="{Binding BrushSize}" VerticalAlignment="Center"/>
                  </Grid>
                  <Slider Value="{Binding BrushSize}" Minimum="1" Maximum="10" IsSnapToTickEnabled="True" TickFrequency="1" />

                  <ContentPresenter Content="{Binding}" ContentTemplate="{StaticResource TextureGridTemplate}"/>
                </StackPanel>
              </DataTemplate>

              <DataTemplate DataType="{x:Type tools:BucketFillTool}">
                <StackPanel Spacing="8">
                  <CheckBox Content="Contiguous Fill" IsChecked="{Binding IsContiguous}" />
                  <CheckBox Content="Only fill same scenery" IsChecked="{Binding OnlyFillSameScenery}" />
                  
                  <ContentPresenter Content="{Binding}" ContentTemplate="{StaticResource TextureGridTemplate}"/>

                  <TextBlock Text="Fills connected areas of the same texture." 
                             IsVisible="{Binding IsContiguous}"
                             FontStyle="Italic" FontSize="11" TextWrapping="Wrap" />
                  <TextBlock Text="replaces all instances of the clicked texture globally." 
                             IsVisible="{Binding !IsContiguous}"
                             FontStyle="Italic" FontSize="11" TextWrapping="Wrap" />
                </StackPanel>
              </DataTemplate>
            </ContentControl.DataTemplates>
          </ContentControl>
        </StackPanel>
      </ScrollViewer>
    </Border>
</UserControl>

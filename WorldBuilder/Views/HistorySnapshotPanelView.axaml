<UserControl
    x:Class="WorldBuilder.Views.HistorySnapshotPanelView"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:conv="clr-namespace:WorldBuilder.Lib.Converters"
    xmlns:i="using:Avalonia.Xaml.Interactivity"
    xmlns:ia="using:Avalonia.Xaml.Interactions.Core"
    xmlns:lib="clr-namespace:WorldBuilder.Lib"
    xmlns:views="using:WorldBuilder.Views"
    xmlns:vm="using:WorldBuilder.ViewModels"
    x:CompileBindings="False"
    x:DataType="vm:HistorySnapshotPanelViewModel">
    <UserControl.Resources>
        <conv:IsNotZeroConverter x:Key="IsNotZeroConverter" />
    </UserControl.Resources>
    <UserControl.Styles>
        <Style Selector="ListBoxItem.current">
            <Setter Property="Background" Value="{DynamicResource SystemAccentColor}" />
            <Setter Property="FontWeight" Value="Bold" />
        </Style>
        <Style Selector="StackPanel.dimmed">
            <Setter Property="Opacity" Value="0.3" />
        </Style>
        <Style Selector="ListBoxItem.snapshot">
            <Setter Property="Background" Value="{DynamicResource SystemControlBackgroundAltMediumBrush}" />
        </Style>
        <Style Selector="TextBlock.section-header">
            <Setter Property="FontWeight" Value="Bold" />
        </Style>
    </UserControl.Styles>

    <DockPanel LastChildFill="True">
        <StackPanel Orientation="Vertical">
            <!--  Snapshots and History Lists  -->
            <TextBlock
                Margin="8,8,8,4"
                Classes="section-header"
                Text="History" />
            <ScrollViewer MaxHeight="200">
                <StackPanel Orientation="Vertical">
                    <!--  Snapshots Section  -->
                    <StackPanel IsVisible="{Binding SnapshotItems.Count, Converter={StaticResource IsNotZeroConverter}}">

                        <ListBox
                            x:Name="SnapshotsListBox"
                            ItemsSource="{Binding SnapshotItems}"
                            ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                            SelectedItem="{Binding SelectedSnapshot}">
                            <i:Interaction.Behaviors>
                                <ia:EventTriggerBehavior EventName="SelectionChanged">
                                    <ia:InvokeCommandAction Command="{Binding SelectSnapshotCommand}" CommandParameter="{Binding #SnapshotsListBox.SelectedItem}" />
                                </ia:EventTriggerBehavior>
                                <ia:EventTriggerBehavior EventName="DoubleTapped">
                                    <ia:InvokeCommandAction Command="{Binding RenameSnapshotCommand}" CommandParameter="{Binding #SnapshotsListBox.SelectedItem}" />
                                </ia:EventTriggerBehavior>
                            </i:Interaction.Behaviors>
                            <ListBox.Styles>
                                <Style Selector="ListBoxItem">
                                    <Setter Property="Padding" Value="8,4" />
                                </Style>
                            </ListBox.Styles>
                            <ListBox.ItemTemplate>
                                <DataTemplate x:DataType="lib:HistoryListItem">
                                    <StackPanel Orientation="Horizontal" Spacing="5">
                                        <TextBlock Text="📸" />
                                        <TextBlock Text="{Binding Description}" />
                                    </StackPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                            <ListBox.ContextMenu>
                                <ContextMenu>
                                    <MenuItem
                                        Command="{Binding RevertToStateCommand}"
                                        CommandParameter="{Binding #SnapshotsListBox.SelectedItem}"
                                        Header="Revert to This Snapshot" />
                                    <MenuItem
                                        Command="{Binding RenameSnapshotCommand}"
                                        CommandParameter="{Binding #SnapshotsListBox.SelectedItem}"
                                        Header="Rename" />
                                    <MenuItem
                                        Command="{Binding DeleteItemCommand}"
                                        CommandParameter="{Binding #SnapshotsListBox.SelectedItem}"
                                        Header="Delete" />
                                </ContextMenu>
                            </ListBox.ContextMenu>
                        </ListBox>
                    </StackPanel>

                    <!--  History Section  -->
                    <StackPanel IsVisible="{Binding HistoryItems.Count, Converter={StaticResource IsNotZeroConverter}}">
                        <ListBox
                            x:Name="HistoryListBox"
                            ItemsSource="{Binding HistoryItems}"
                            ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                            SelectedItem="{Binding SelectedHistory}">
                            <i:Interaction.Behaviors>
                                <ia:EventTriggerBehavior EventName="SelectionChanged">
                                    <ia:InvokeCommandAction Command="{Binding SelectHistoryItemCommand}" CommandParameter="{Binding #HistoryListBox.SelectedItem}" />
                                </ia:EventTriggerBehavior>
                            </i:Interaction.Behaviors>
                            <ListBox.Styles>
                                <Style Selector="ListBoxItem">
                                    <Setter Property="Padding" Value="8,4" />
                                </Style>
                            </ListBox.Styles>
                            <ListBox.ItemTemplate>
                                <DataTemplate x:DataType="lib:HistoryListItem">
                                    <Panel>
                                        <StackPanel
                                            Classes.dimmed="{Binding IsDimmed}"
                                            Orientation="Horizontal"
                                            Spacing="5">
                                            <TextBlock Text="{Binding IsOriginalDocument, Converter={x:Static conv:BoolToStringConverter.DocumentOrHistory}}" />
                                            <TextBlock Text="{Binding Description}" />
                                        </StackPanel>
                                    </Panel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                            <ListBox.ContextMenu>
                                <ContextMenu>
                                    <MenuItem
                                        Command="{Binding RevertToStateCommand}"
                                        CommandParameter="{Binding #HistoryListBox.SelectedItem}"
                                        Header="Revert to This State" />
                                    <MenuItem
                                        Command="{Binding DeleteItemCommand}"
                                        CommandParameter="{Binding #HistoryListBox.SelectedItem}"
                                        Header="Delete"
                                        IsVisible="{Binding #HistoryListBox.SelectedItem.IsOriginalDocument, Converter={x:Static conv:BoolConverters.Not}}" />
                                </ContextMenu>
                            </ListBox.ContextMenu>
                        </ListBox>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>
            <!--  Toolbar  -->
            <StackPanel
                Margin="5"
                HorizontalAlignment="Right"
                DockPanel.Dock="Top"
                Orientation="Horizontal"
                Spacing="5">
                <Button
                    Command="{Binding CreateSnapshotCommand}"
                    Content="🕓"
                    ToolTip.Tip="New Snapshot" />
                <Button
                    Command="{Binding DeleteItemCommand}"
                    CommandParameter="{Binding SelectedItem}"
                    Content="🗑️"
                    IsEnabled="{Binding SelectedItem, Converter={x:Static conv:ObjectConverters.IsNotNull}}"
                    ToolTip.Tip="Delete Selected" />
                <Button
                    Command="{Binding RevertToStateCommand}"
                    CommandParameter="{Binding SelectedItem}"
                    Content="⟳"
                    IsEnabled="{Binding CanRevert}"
                    ToolTip.Tip="Revert to Selected State" />
            </StackPanel>
        </StackPanel>
    </DockPanel>
</UserControl>
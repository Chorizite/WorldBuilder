name: Build Edge
on:
  push:
    branches:
      - master
      - main
      - '**'  # Run on all branches
permissions:
  contents: write
  pages: write
  id-token: write
jobs:
  build-and-release-edge:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for GitVersion and changelog

    - name: Install Dependencies
      run: |
        sudo sed -i 's/yes/no/g' /etc/initramfs-tools/update-initramfs.conf # Disable initramfs update
        sudo rm -f /var/lib/man-db/auto-update # Disable man-db update
        sudo apt update && sudo apt install -y nsis nsis-pluginapi
    
    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v0.10.2
      with:
        versionSpec: '6.4.x'
    
    - name: Determine Version
      id: gitversion
      uses: gittools/actions/gitversion/execute@v0.10.2
      with:
        useConfigFile: true

    - name: Set version envs
      run: |
        echo "ASSEMBLY_VERSION=${{ steps.gitversion.outputs.major }}.0.0" >> $GITHUB_ENV
        echo "APP_VERSION=${{ steps.gitversion.outputs.majorMinorPatch }}+${{ steps.gitversion.outputs.commitsSinceVersionSource }}" >> $GITHUB_ENV

    - name: Build
      run: dotnet publish WorldBuilder.Windows/WorldBuilder.Windows.csproj -r win-x64 -p:InformationalVersion=${{ env.APP_VERSION }} -p:Version=${{ env.APP_VERSION }} -p:AssemblyVersion=${{ env.ASSEMBLY_VERSION }}
    
    - name: Get Latest Release Tag
      id: get_latest_release
      run: |
        latest_tag=$(gh release list --exclude-pre-releases --limit 1 --json tagName --jq '.[0].tagName')
        echo "LATEST_TAG=$latest_tag" >> $GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Delete existing 'latest' release
      if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
      run: |
        gh release delete latest --yes || true
        git push origin :refs/tags/latest || true
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate Changelog
      id: changelog
      run: |
        gh api \
          --method POST \
          -H "Accept: application/vnd.github+json" \
          /repos/${{ github.repository }}/releases/generate-notes \
          -f tag_name='latest' \
          -f target_commitish='${{ github.ref_name }}' \
          -f previous_tag_name='${{ steps.get_latest_release.outputs.LATEST_TAG }}' \
          > changelog.json
        
        # Extract the body from the response
        CHANGELOG_BODY=$(jq -r '.body' changelog.json)
        
        # Save to file and output
        echo "$CHANGELOG_BODY" > "${{ env.APP_VERSION }}.md"
        
        # Set output using multiline syntax
        {
          echo 'changelog<<EOF'
          echo "$CHANGELOG_BODY"
          echo 'EOF'
        } >> $GITHUB_OUTPUT
        
        # Print changelog
        echo "Changelog:"
        cat "${{ env.APP_VERSION }}.md"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Build installer
      run: |
          makensis -DVERSION="${{ env.APP_VERSION }}" -DBUILDPATH="${{ github.workspace }}/WorldBuilder.Windows/bin/Release/net8.0-windows/win-x64/publish/" "${{ github.workspace }}/Installer.nsi"
    
    
    - name: Create/Update Pre-release
      if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: latest
        name: "Edge"
        body: |
          ## 🚀 Edge Build ${{ env.APP_VERSION }}
          
          This is an automated pre-release build from the latest commit.
          
          ### 📋 Changelog
          ${{ steps.changelog.outputs.changelog }}
          
          ### ⚠️ Warning
          This is a preview build and may contain bugs or incomplete features.
        files: ./WorldBuilderInstaller-${{ env.APP_VERSION }}.exe
        prerelease: true
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
